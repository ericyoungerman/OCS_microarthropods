---
title: "Ocs microarthropods"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries

```{r message=FALSE, warning=FALSE}

library(tidyverse)
library(multcomp)
library(emmeans)
library(knitr)
library(patchwork) ##install.packages("patchwork")
library(skimr)     ##install.packages("skimr")
library(readxl)
library(janitor) ##install.packages("janitor")
library(kableExtra) ##install.packages("kableExtra")
library(WrensBookshelf)##install.packages("WrensBookshelf")
## For GLM modeling
library(monet)
library(DHARMa)
library(glmmTMB)
library(performance)
```

# Load and clean data

## Load data

``` {r}
ocs_invertebrates_raw <- read_excel("~/Github/OCS_microarthropods/raw-data/ocs_invertebrates_kg.xlsx")
ocs_invertebrates_raw$block <- as.factor(ocs_invertebrates_raw$block)
ocs_invertebrates_raw$entry <- as.factor(ocs_invertebrates_raw$entry)
ocs_invertebrates_raw$system <- as.factor(ocs_invertebrates_raw$system)
ocs_invertebrates_raw <- ocs_invertebrates_raw |> 
  mutate(across(where(is.numeric),round))


kable(head(ocs_invertebrates_raw))

```

##Clean data

```{r}
 #Filter relevant data (we can't use data from alley and corn)
ocs_invertebrates_clean <- ocs_invertebrates_raw |>  
  filter(system %in% c("HF", "LF", "EWM", "RT"))

# Display cleaned dataset
kable(head(ocs_invertebrates_clean))


```

##Model testing

```{r}
 test_glmm_models <- function(response_var, data) {
  
  # Check for variation in the response variable
  if (var(data[[response_var]], na.rm = TRUE) == 0) {
    stop(paste("No variation in response variable:", response_var))
  }
  
  # Define model formula
  formula <- as.formula(paste(response_var, "~ system * entry + block + (1 | block:system)"))
  
  # Safe model fitting
  safe_glmmTMB <- function(...) {
    tryCatch(glmmTMB(...), error = function(e) NULL)
  }
  
  # Fit models
  models <- list(
    binom1      = safe_glmmTMB(formula, family = nbinom1(link = "log"), data = data),
    binom2      = safe_glmmTMB(formula, family = nbinom2(link = "log"), data = data),
    poiss       = safe_glmmTMB(formula, family = poisson(link = "log"), data = data),
    tweedie     = safe_glmmTMB(formula, family = tweedie(link = "log"), data = data),
    zi          = safe_glmmTMB(formula, family = nbinom1(link = "log"), ziformula = ~1, data = data),
    zi_tweedie  = safe_glmmTMB(formula, family = tweedie(link = "log"), ziformula = ~1, data = data)
  )
  
  # Collect AICs
  aic_table <- data.frame(
    Model = character(),
    AIC = numeric(),
    stringsAsFactors = FALSE
  )
  
  for (model_name in names(models)) {
    model <- models[[model_name]]
    aic_val <- tryCatch(AIC(model), error = function(e) NA)
    aic_table <- rbind(aic_table, data.frame(Model = model_name, AIC = aic_val))
  }
  
  # Order by AIC and get the two best models
  aic_table <- aic_table[order(aic_table$AIC), ]
  best_models <- head(aic_table$Model, 2)
  
  # Initialize full diagnostics table
  diagnostics <- aic_table
  diagnostics$Dispersion <- NA
  diagnostics$ZeroInfl_p <- NA
  
  # Run diagnostics only on top 2 models
  for (model_name in best_models) {
    model <- models[[model_name]]
    if (!is.null(model)) {
      dispersion <- tryCatch({
        res <- residuals(model, type = "pearson")
        round(sum(res^2) / df.residual(model), 2)
      }, error = function(e) NA)
      
      zi_p <- tryCatch({
        sim <- simulateResiduals(model, plot = FALSE)
        testZeroInflation(sim, plot = FALSE)$p.value
      }, error = function(e) NA)
      
      diagnostics[diagnostics$Model == model_name, "Dispersion"] <- dispersion
      diagnostics[diagnostics$Model == model_name, "ZeroInfl_p"] <- zi_p
    }
  }

  cat("\n--- Model Diagnostics for", response_var, "---\n")
  print(diagnostics)
  
  return(list(models = models, diagnostics = diagnostics))
}

```
###Total organisms

```{r}
models_total_organisms <- test_glmm_models("total_organisms", ocs_invertebrates_clean)

```
```{r}
simulateResiduals(models_total_organisms$models$binom1, plot = TRUE)
check_model(models_total_organisms$models$binom1)
simulateResiduals(models_total_organisms$models$tweedie, plot = TRUE)
check_model(models_total_organisms$models$tweedie)


```

####Anova (almost significant)
```{r}
# `test_terms` is from monet and allows for a Type III anova for glmmTMB
total_organisms.binom1.anova <- test_terms(formula = total_organisms ~ system * entry + block, # fixed effects go here
                                           data = ocs_invertebrates_clean,
                                           extra_formula = ~ (1|block:system), # random effects go here
                                           fit_fun = glmmTMB,
                                           fit_arg = list(family=nbinom1(link="log"))); total_organisms.binom1.anova # put the family you decided on in the fit_arg
```
<br>

####Means comparisons
```{r}
# Define model object (you can swap in different ones)
mod <- models_total_organisms$models$binom1

# Tukey HSD pairwise comparisons
tukey_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "tukey", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "tukey", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "tukey", type = "response")
)

# Fisher LSD (no adjustment)
lsd_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "none", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "none", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "none", type = "response")
)

# CLDs for Tukey
cld_results_tukey <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "tukey", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "tukey", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "tukey", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# CLDs for Fisher LSD
cld_results_lsd <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "none", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "none", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "none", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# Example: Accessing outputs
# Tukey
tukey_results$entry$emmeans
tukey_results$system$emmeans
tukey_results$system_entry$emmeans
tukey_results$entry$contrasts
tukey_results$system$contrasts
tukey_results$system_entry$contrasts
cld_results_tukey$entry
cld_results_tukey$system
cld_results_tukey$system_entry

# LSD
lsd_results$entry$emmeans
lsd_results$system$emmeans
lsd_results$system_entry$emmeans
lsd_results$entry$contrasts
lsd_results$system$contrasts
lsd_results$system_entry$contrasts
cld_results_lsd$entry
cld_results_lsd$system
cld_results_lsd$system_entry

```

####Figures
```{r}
ocs_invertebrates_clean |> 
  left_join(cld_results_lsd$system_entry) |> 
  ggplot(aes(x = factor(system, levels = c("HF", "LF", "EWM", "RT")), 
             y = response, fill = system)) +
  facet_wrap(~entry, labeller = labeller(
    entry = c("A" = "Entry Point A", "B" = "Entry Point B")
  )) +
  geom_bar(stat = "identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin = response - SE, ymax = response + SE), 
                width = 0.2, position = position_dodge(0.9)) +
  #geom_text(aes(label = trimws(.group), y = response + SE + 1.5), 
            #size = 7) +
  labs(
    x = "",
    y = expression("Density" ~ (individuals ~ kg^{-1} ~ "dry soil")),
    subtitle = expression(italic("Not significant"))
  ) +
  scale_x_discrete(labels = c("High\nfertility", "Low\nfertility", 
                              "Enhanced\nweed\nmanagement", "Reduced\ntillage")) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.3))) +
  scale_fill_WB_d(name = "BlueberriesForSal", direction = 1) +
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 12),
    axis.title = element_text(size = 24),
    axis.text = element_text(size = 16),
    plot.subtitle = element_text(size = 24, face = "italic")
  )
ggsave("total_organisms_kg.png", width = 10, height = 6, dpi = 300)
```

<br>

###COLLEMBOLA

```{r}
models_total_collembola <- test_glmm_models("total_collembola", ocs_invertebrates_clean)



```
```{r}
simulateResiduals(models_total_collembola$models$binom1, plot = TRUE)
check_model(models_total_collembola$models$binom1)
simulateResiduals(models_total_collembola$models$tweedie, plot = TRUE)
check_model(models_total_collembola$models$tweedie)
```


####Anova (not significant)
```{r}
# `test_terms` is from monet and allows for a Type III anova for glmmTMB
total_collembola.tweedie.anova <- test_terms(formula = total_collembola ~ system * entry + block, # fixed effects go here
                                           data = ocs_invertebrates_clean,
                                           extra_formula = ~ (1|block:system), # random effects go here
                                           fit_fun = glmmTMB,
                                           fit_arg = list(family=tweedie(link="log"))); total_collembola.tweedie.anova # put the family you decided on in the fit_arg
```
<br>

####Means comparisons
```{r}
# Define model object (you can swap in different ones)
mod <- models_total_collembola$models$tweedie

# Tukey HSD pairwise comparisons
tukey_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "tukey", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "tukey", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "tukey", type = "response")
)

# Fisher LSD (no adjustment)
lsd_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "none", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "none", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "none", type = "response")
)

# CLDs for Tukey
cld_results_tukey <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "tukey", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "tukey", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "tukey", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# CLDs for Fisher LSD
cld_results_lsd <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "none", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "none", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "none", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# Example: Accessing outputs
# Tukey
tukey_results$entry$emmeans
tukey_results$system$emmeans
tukey_results$system_entry$emmeans
tukey_results$entry$contrasts
tukey_results$system$contrasts
tukey_results$system_entry$contrasts
cld_results_tukey$entry
cld_results_tukey$system
cld_results_tukey$system_entry

# LSD
lsd_results$entry$emmeans
lsd_results$system$emmeans
lsd_results$system_entry$emmeans
lsd_results$entry$contrasts
lsd_results$system$contrasts
lsd_results$system_entry$contrasts
cld_results_lsd$entry
cld_results_lsd$system
cld_results_lsd$system_entry

```

<br>

####Entomobryidae (Too little data for now)
```{r}
models_entomobryidae <- test_glmm_models("entomobryidae", ocs_invertebrates_clean)


```
```{r}
simulateResiduals(models_entomobryidae$models$binom1, plot = TRUE)
check_model(models_entomobryidae$models$binom1)
simulateResiduals(models_entomobryidae$models$binom2, plot = TRUE)
check_model(models_entomobryidae$modelsbinom2)
```

#####Anova
```{r}
# `test_terms` is from monet and allows for a Type III anova for glmmTMB
entomobryidae.nbinom1.anova <- test_terms(formula = entomobryidae ~ system * entry + block, # fixed effects go here
                                           data = ocs_invertebrates_clean,
                                           extra_formula = ~ (1|block:system), # random effects go here
                                           fit_fun = glmmTMB,
                                           fit_arg = list(family=nbinom1(link="log"))); entomobryidae.nbinom1.anova # put the family you decided on in the fit_arg
```
<br>

#####Means comparisons
```{r}
# Define model object (you can swap in different ones)
mod <- models_entomobryidae$models$binom1


# Tukey HSD pairwise comparisons
tukey_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "tukey", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "tukey", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "tukey", type = "response")
)

# Fisher LSD (no adjustment)
lsd_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "none", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "none", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "none", type = "response")
)

# CLDs for Tukey
cld_results_tukey <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "tukey", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "tukey", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "tukey", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# CLDs for Fisher LSD
cld_results_lsd <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "none", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "none", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "none", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# Example: Accessing outputs
# Tukey
tukey_results$entry$emmeans
tukey_results$system$emmeans
tukey_results$system_entry$emmeans
tukey_results$entry$contrasts
tukey_results$system$contrasts
tukey_results$system_entry$contrasts
cld_results_tukey$entry
cld_results_tukey$system
cld_results_tukey$system_entry

# LSD
lsd_results$entry$emmeans
lsd_results$system$emmeans
lsd_results$system_entry$emmeans
lsd_results$entry$contrasts
lsd_results$system$contrasts
lsd_results$system_entry$contrasts
cld_results_lsd$entry
cld_results_lsd$system
cld_results_lsd$system_entry

```

####Isotomidae 
```{r}
models_isotomidae <- test_glmm_models("isotomidae", ocs_invertebrates_clean)

```

<br>

```{r}
simulateResiduals(models_isotomidae$models$tweedie, plot = TRUE)
check_model(models_isotomidae$models$tweedie)
simulateResiduals(models_isotomidae$models$zi_tweedie, plot = TRUE)
check_model(models_isotomidae$models$zi_tweedie)
```

<br>
#####anova (not significant)
```{r}
# `test_terms` is from monet and allows for a Type III anova for glmmTMB
isotomidae.tweedie.anova <- test_terms(formula = isotomidae ~ system * entry + block, # fixed effects go here
                                           data = ocs_invertebrates_clean,
                                           extra_formula = ~ (1|block:system), # random effects go here
                                           fit_fun = glmmTMB,
                                           fit_arg = list(family=tweedie(link="log"))); isotomidae.tweedie.anova # put the family you decided on in the fit_arg
```
<br>

#####Means comparisons
```{r}
# Define model object (you can swap in different ones)
mod <- models_isotomidae$models$tweedie 

# Tukey HSD pairwise comparisons
tukey_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "tukey", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "tukey", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "tukey", type = "response")
)

# Fisher LSD (no adjustment)
lsd_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "none", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "none", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "none", type = "response")
)

# CLDs for Tukey
cld_results_tukey <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "tukey", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "tukey", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "tukey", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# CLDs for Fisher LSD
cld_results_lsd <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "none", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "none", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "none", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# Example: Accessing outputs
# Tukey
tukey_results$entry$emmeans
tukey_results$system$emmeans
tukey_results$system_entry$emmeans
tukey_results$entry$contrasts
tukey_results$system$contrasts
tukey_results$system_entry$contrasts
cld_results_tukey$entry
cld_results_tukey$system
cld_results_tukey$system_entry

# LSD
lsd_results$entry$emmeans
lsd_results$system$emmeans
lsd_results$system_entry$emmeans
lsd_results$entry$contrasts
lsd_results$system$contrasts
lsd_results$system_entry$contrasts
cld_results_lsd$entry
cld_results_lsd$system
cld_results_lsd$system_entry

```
<br>

####Onychiuridae (treatment is significant)


```{r}
models_onychiuridae <- test_glmm_models("onychiuridae", ocs_invertebrates_clean)

```
```{r}
simulateResiduals(models_isotomidae$models$zi_tweedie, plot = TRUE)
check_model(models_isotomidae$models$zi_tweedie)
simulateResiduals(models_isotomidae$models$tweedie, plot = TRUE)
check_model(models_isotomidae$models$tweedie)
```

######anova (significant)
```{r}
# `test_terms` is from monet and allows for a Type III anova for glmmTMB
onychiuridae.tweedie.anova <- test_terms(
  formula = onychiuridae ~ system * entry + block,  # fixed effects
  data = ocs_invertebrates_clean,
  extra_formula = ~ (1 | block:system),  # random effects
  fit_fun = glmmTMB,
  fit_arg = list(
    family = tweedie(link = "log")
    #ziformula = ~1  # zero-inflation model with intercept
  )
)

onychiuridae.tweedie.anova
```
#####Means comparisons
```{r}
# Define model object (you can swap in different ones)
mod <- models_onychiuridae$models$tweedie

# Tukey HSD pairwise comparisons
tukey_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "tukey", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "tukey", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "tukey", type = "response")
)

# Fisher LSD (no adjustment)
lsd_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "none", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "none", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "none", type = "response")
)

# CLDs for Tukey
cld_results_tukey <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "tukey", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "tukey", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "tukey", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# CLDs for Fisher LSD
cld_results_lsd <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "none", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "none", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "none", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# Example: Accessing outputs
# Tukey
tukey_results$entry$emmeans
tukey_results$system$emmeans
tukey_results$system_entry$emmeans
tukey_results$entry$contrasts
tukey_results$system$contrasts
tukey_results$system_entry$contrasts
cld_results_tukey$entry
cld_results_tukey$system
cld_results_tukey$system_entry

# LSD
lsd_results$entry$emmeans
lsd_results$system$emmeans
lsd_results$system_entry$emmeans
lsd_results$entry$contrasts
lsd_results$system$contrasts
lsd_results$system_entry$contrasts
cld_results_lsd$entry
cld_results_lsd$system
cld_results_lsd$system_entry

```

#####Figure

```{r message=FALSE}
ocs_invertebrates_clean |> 
  left_join(cld_results_lsd$system_entry) |> 
  ggplot(aes(x = factor(system, levels = c("HF", "LF", "EWM", "RT")), 
             y = response, fill = system)) +
  facet_wrap(~entry, labeller = labeller(
    entry = c("A" = "Entry Point A", "B" = "Entry Point B")
  )) +
  geom_bar(stat = "identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin = response - SE, ymax = response + SE), 
                width = 0.2, position = position_dodge(0.9)) +
  geom_text(aes(label = trimws(.group), y = response + SE + 0.35), 
            size = 7) +
  labs(
    x = "",
    y = expression("Density" ~ (individuals ~ kg^{-1} ~ "dry soil")),
    subtitle = expression(italic("P < 0.05"))
  ) +
  scale_x_discrete(labels = c("High\nfertility", "Low\nfertility", 
                              "Enhanced\nweed\nmanagement", "Reduced\ntillage")) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.3))) +
  scale_fill_WB_d(name = "BlueberriesForSal", direction = 1) +
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 12),
    axis.title = element_text(size = 24),
    axis.text = element_text(size = 16),
    plot.subtitle = element_text(size = 24, face = "italic")
  )
ggsave("onychiuridae_kg.png", width = 10, height = 6, dpi = 300)
```

####Sminthuridae (not enough data)
```{r}
models_sminthuridae <- test_glmm_models("sminthuridae", ocs_invertebrates_clean)

```
```{r}
simulateResiduals(models_sminthuridae$models$zi_tweedie, plot = TRUE)
check_model(models_isotomidae$models$zi_tweedie)
simulateResiduals(models_sminthuridae$models$binom1, plot = TRUE)
check_model(models_isotomidae$models$tweedie)
```


#####Anova
```{r}
# `test_terms` is from monet and allows for a Type III anova for glmmTMB
sminthuridae.nbinom1.anova <- test_terms(formula = sminthuridae ~ system * entry + block, # fixed effects go here
                                           data = ocs_invertebrates_clean,
                                           extra_formula = ~ (1|block:system), # random effects go here
                                           fit_fun = glmmTMB,
                                           fit_arg = list(family=nbinom1(link="log"))); sminthuridae.nbinom1.anova # put the family you decided on in the fit_arg
```


###ACARI
```{r}
models_total_mites <- test_glmm_models("total_mites", ocs_invertebrates_clean)


```
<br>
```{r}
simulateResiduals(models_total_mites$models$tweedie, plot = TRUE)
check_model(models_total_mites$models$tweedie)
simulateResiduals(models_total_mites$models$zi_tweedie, plot = TRUE)
check_model(models_total_mites$models$zi_tweedie)
simulateResiduals(models_total_mites$models$zi, plot = TRUE)
check_model(models_total_mites$models$zi)

```

<br>
####anova (significant)
```{r}
# `test_terms` is from monet and allows for a Type III anova for glmmTMB
total_mites.tweedie.anova <- test_terms(formula = total_mites ~ system * entry + block, # fixed effects go here
                                           data = ocs_invertebrates_clean,
                                   extra_formula = ~ (1|block:system), # random effects go here
                                    fit_fun = glmmTMB,
                                   fit_arg = list(family=tweedie(link="log"))); total_mites.tweedie.anova # put the family you decided on in the fit_arg
```
<br>
####Means comparisons
```{r}
# Define model object (you can swap in different ones)
mod <- models_total_mites$models$tweedie

# Tukey HSD pairwise comparisons
tukey_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "tukey", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "tukey", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "tukey", type = "response")
)

# Fisher LSD (no adjustment)
lsd_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "none", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "none", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "none", type = "response")
)

# CLDs for Tukey
cld_results_tukey <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "tukey", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "tukey", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "tukey", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# CLDs for Fisher LSD
cld_results_lsd <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "none", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "none", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "none", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# Example: Accessing outputs
# Tukey
tukey_results$entry$emmeans
tukey_results$system$emmeans
tukey_results$system_entry$emmeans
tukey_results$entry$contrasts
tukey_results$system$contrasts
tukey_results$system_entry$contrasts
cld_results_tukey$entry
cld_results_tukey$system
cld_results_tukey$system_entry

# LSD
lsd_results$entry$emmeans
lsd_results$system$emmeans
lsd_results$system_entry$emmeans
lsd_results$entry$contrasts
lsd_results$system$contrasts
lsd_results$system_entry$contrasts
cld_results_lsd$entry
cld_results_lsd$system
cld_results_lsd$system_entry

```

<br>

####Figure
```{r message=FALSE}
ocs_invertebrates_clean |> 
  left_join(cld_results_lsd$system_entry) |> 
  ggplot(aes(x = factor(system, levels = c("HF", "LF", "EWM", "RT")), 
             y = response, fill = system)) +
  facet_wrap(~entry, labeller = labeller(
    entry = c("A" = "Entry Point A", "B" = "Entry Point B")
  )) +
  geom_bar(stat = "identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin = response - SE, ymax = response + SE), 
                width = 0.2, position = position_dodge(0.9)) +
  geom_text(aes(label = trimws(.group), y = response + SE + 3), 
            size = 7) +
  labs(
    x = "",
    y = expression("Density" ~ (individuals ~ kg^{-1} ~ "dry soil")),
    subtitle = expression(italic("P < 0.001"))
  ) +
  scale_x_discrete(labels = c("High\nfertility", "Low\nfertility", 
                              "Enhanced\nweed\nmanagement", "Reduced\ntillage")) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.3))) +
  scale_fill_WB_d(name = "BlueberriesForSal", direction = 1) +
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 12),
    axis.title = element_text(size = 24),
    axis.text = element_text(size = 16),
    plot.subtitle = element_text(size = 24, face = "italic")
  )
ggsave("total_mites_kg.png", width = 10, height = 6, dpi = 300)
```














####Astigmata, 
```{r}

models_astigmata <- test_glmm_models("astigmata", ocs_invertebrates_clean)


```

<br>

```{r}
simulateResiduals(models_astigmata$models$tweedie, plot = TRUE)
check_model(models_astigmata$models$tweedie)
simulateResiduals(models_astigmata$models$zi_tweedie, plot = TRUE)
check_model(models_astigmata$models$zi_tweedie)
simulateResiduals(models_astigmata$models$zi, plot = TRUE)
check_model(models_astigmata$models$zi)

```

#####anova (significant)
```{r}
# `test_terms` is from monet and allows for a Type III anova for glmmTMB
total_astigmata.tweedie.anova <- test_terms(formula = astigmata ~ system * entry + block, # fixed effects go here
                                           data = ocs_invertebrates_clean,
                                   extra_formula = ~ (1|block:system), # random effects go here
                                    fit_fun = glmmTMB,
                                   fit_arg = list(family=tweedie(link="log"))); total_astigmata.tweedie.anova # put the family you decided on in the fit_arg
```
<br>
#####Means comparisons
```{r}
# Define model object (you can swap in different ones)
mod <- models_astigmata$models$tweedie

# Tukey HSD pairwise comparisons
tukey_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "tukey", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "tukey", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "tukey", type = "response")
)

# Fisher LSD (no adjustment)
lsd_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "none", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "none", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "none", type = "response")
)

# CLDs for Tukey
cld_results_tukey <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "tukey", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "tukey", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "tukey", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# CLDs for Fisher LSD
cld_results_lsd <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "none", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "none", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "none", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# Example: Accessing outputs
# Tukey
tukey_results$entry$emmeans
tukey_results$system$emmeans
tukey_results$system_entry$emmeans
tukey_results$entry$contrasts
tukey_results$system$contrasts
tukey_results$system_entry$contrasts
cld_results_tukey$entry
cld_results_tukey$system
cld_results_tukey$system_entry

# LSD
lsd_results$entry$emmeans
lsd_results$system$emmeans
lsd_results$system_entry$emmeans
lsd_results$entry$contrasts
lsd_results$system$contrasts
lsd_results$system_entry$contrasts
cld_results_lsd$entry
cld_results_lsd$system
cld_results_lsd$system_entry

```

#####Figures
```{r message=FALSE}
ocs_invertebrates_clean |> 
  left_join(cld_results_lsd$system_entry) |> 
  ggplot(aes(x = factor(system, levels = c("HF", "LF", "EWM", "RT")), 
             y = response, fill = system)) +
  facet_wrap(~entry, labeller = labeller(
    entry = c("A" = "Entry Point A", "B" = "Entry Point B")
  )) +
  geom_bar(stat = "identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin = response - SE, ymax = response + SE), 
                width = 0.2, position = position_dodge(0.9)) +
  geom_text(aes(label = trimws(.group), y = response + SE + 1), 
            size = 7) +
  labs(
    x = "",
    y = expression("Density" ~ (individuals ~ kg^{-1} ~ "dry soil")),
    subtitle = expression(italic("P < 0.001"))
  ) +
  scale_x_discrete(labels = c("High\nfertility", "Low\nfertility", 
                              "Enhanced\nweed\nmanagement", "Reduced\ntillage")) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.3))) +
  scale_fill_WB_d(name = "BlueberriesForSal", direction = 1) +
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 12),
    axis.title = element_text(size = 24),
    axis.text = element_text(size = 16),
    plot.subtitle = element_text(size = 24, face = "italic")
  )
ggsave("total_astigmata_kg.png", width = 10, height = 6, dpi = 300)
```

<br>


#Mesostigmata, Treatment by Entry is significant
```{r}

models_mesostigmata <- test_glmm_models("mesostigmata", ocs_invertebrates_clean)

```
<br>

```{r}
simulateResiduals(models_mesostigmata$models$tweedie, plot = TRUE)
check_model(models_mesostigmata$models$tweedie)
simulateResiduals(models_mesostigmata$models$zi_tweedie, plot = TRUE)
check_model(models_mesostigmata$models$zi_tweedie)


```

####anova
```{r}
# `test_terms` is from monet and allows for a Type III anova for glmmTMB
total_mesostigmata.tweedie.anova <- test_terms(formula = mesostigmata ~ system * entry + block, # fixed effects go here
                                           data = ocs_invertebrates_clean,
                                   extra_formula = ~ (1|block:system), # random effects go here
                                    fit_fun = glmmTMB,
                                   fit_arg = list(family=tweedie(link="log"))); total_mesostigmata.tweedie.anova# put the family you decided on in the fit_arg
```

<br>


####Means comparisons
```{r}
# Define model object (you can swap in different ones)
mod <- models_mesostigmata$models$tweedie

# Tukey HSD pairwise comparisons
tukey_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "tukey", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "tukey", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "tukey", type = "response")
)

# Fisher LSD (no adjustment)
lsd_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "none", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "none", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "none", type = "response")
)

# CLDs for Tukey
cld_results_tukey <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "tukey", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "tukey", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "tukey", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# CLDs for Fisher LSD
cld_results_lsd <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "none", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "none", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "none", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# Example: Accessing outputs
# Tukey
tukey_results$entry$emmeans
tukey_results$system$emmeans
tukey_results$system_entry$emmeans
tukey_results$entry$contrasts
tukey_results$system$contrasts
tukey_results$system_entry$contrasts
cld_results_tukey$entry
cld_results_tukey$system
cld_results_tukey$system_entry

# LSD
lsd_results$entry$emmeans
lsd_results$system$emmeans
lsd_results$system_entry$emmeans
lsd_results$entry$contrasts
lsd_results$system$contrasts
lsd_results$system_entry$contrasts
cld_results_lsd$entry
cld_results_lsd$system
cld_results_lsd$system_entry

```




```{r}
# Then move on to post-hoc using emmeans if indicated by the ANOVA. 
total_mesostigmata.emm <- emmeans(models_total_mesostigmata$tweedie, ~treatments|entry, type="response"); pwpm(total_mesostigmata.emm , adjust="none")

# Generate CLD output
cld_total_mesostigmata <- cld(total_mesostigmata.emm, Letters = letters, adjust = "none", sort = TRUE, reversed = TRUE)

# Print the results
cld_total_mesostigmata


```

```{r message=FALSE}
ocs_invertebrates_clean |> 
  left_join(cld_total_mesostigmata) |> 
  ggplot(aes(x = factor(treatments, levels = c("HF", "LF", "EWM", "RT")), 
             y = response, fill = treatments)) +
  facet_wrap(~entry, labeller = labeller(
    entry = c("A" = "Entry Point A", "B" = "Entry Point B")
  )) +
  geom_bar(stat = "identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin = response - SE, ymax = response + SE), 
                width = 0.2, position = position_dodge(0.9)) +
  geom_text(aes(label = trimws(.group), y = response + SE + 0.75), 
            size = 7) +
  labs(
    x = "",
     y = expression("Density" ~ (individuals ~ kg^{-1} ~ "dry soil")),
    subtitle = expression(italic("P < 0.05"))
  ) +
  scale_x_discrete(labels = c("High\nfertility", "Low\nfertility", 
                              "Enhanced\nweed\nmanagement", "Reduced\ntillage")) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.3))) +
  scale_fill_WB_d(name = "BlueberriesForSal", direction = 1) +
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 12),
    axis.title = element_text(size = 24),
    axis.text = element_text(size = 16),
    plot.subtitle = element_text(size = 24, face = "italic")
  )
ggsave("total_mesostigmata_kg.png", width = 10, height = 6, dpi = 300)
```
##oribatida, Not significant

```{r}
models_oribatida <- test_glmm_models("oribatida", ocs_invertebrates_clean)

# Diagnostic residual plots (for best model selection)
res.total_oribatida <- simulateResiduals(models_total_oribatida$tweedie, n = 1000, integerResponse = FALSE)
plot(res.total_oribatida)

sim_residuals <- simulateResiduals(models_oribatida$zi_tweedie, plot = TRUE)
testZeroInflation(sim_residuals)


```
######anova (not significant)
```{r}
# `test_terms` is from monet and allows for a Type III anova for glmmTMB
oribatida.zi_tweedie.anova <- test_terms(
  formula     = oribatida ~ system * entry + block,
  data        = ocs_invertebrates_clean,
  extra_formula = ~ (1 | block:system),
  fit_fun     = glmmTMB,
  fit_arg     = list(
    family     = tweedie(link = "log"),
    ziformula  = ~ 1
  )
)
oribatida.zi_tweedie.anova
```
<br>
####Means comparisons
```{r}
# Define model object (you can swap in different ones)
mod <- models_oribatida$zi_tweedie

# Tukey HSD pairwise comparisons
tukey_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "tukey", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "tukey", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "tukey", type = "response")
)

# Fisher LSD (no adjustment)
lsd_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "none", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "none", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "none", type = "response")
)

# CLDs for Tukey
cld_results_tukey <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "tukey", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "tukey", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "tukey", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# CLDs for Fisher LSD
cld_results_lsd <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "none", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "none", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "none", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# Example: Accessing outputs
# Tukey
tukey_results$entry$emmeans
tukey_results$system$emmeans
tukey_results$system_entry$emmeans
tukey_results$entry$contrasts
tukey_results$system$contrasts
tukey_results$system_entry$contrasts
cld_results_tukey$entry
cld_results_tukey$system
cld_results_tukey$system_entry

# LSD
lsd_results$entry$emmeans
lsd_results$system$emmeans
lsd_results$system_entry$emmeans
lsd_results$entry$contrasts
lsd_results$system$contrasts
lsd_results$system_entry$contrasts
cld_results_lsd$entry
cld_results_lsd$system
cld_results_lsd$system_entry

```


##Phoretic_hypopi, 

```{r}
models_phoretic_hypopi <- test_glmm_models("phoretic_hypopi", ocs_invertebrates_clean)

```

####Anova (almost significant)
```{r}
# `test_terms` is from monet and allows for a Type III anova for glmmTMB
phoretic_hypopi.tweedie.anova <- test_terms(formula = phoretic_hypopi ~ system * entry + block, # fixed effects go here
                                           data = ocs_invertebrates_clean,
                                           extra_formula = ~ (1|block:system), # random effects go here
                                           fit_fun = glmmTMB,
                                           fit_arg = list(family=tweedie(link="log"))); phoretic_hypopi.tweedie.anova # put the family you decided on in the fit_arg
```

<br>
####Means comparisons
```{r}
# Define model object (you can swap in different ones)
mod <- models_phoretic_hypopi$tweedie

# Tukey HSD pairwise comparisons
tukey_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "tukey", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "tukey", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "tukey", type = "response")
)

# Fisher LSD (no adjustment)
lsd_results <- list(
  entry = emmeans(mod, pairwise ~ entry, adjust = "none", type = "response"),
  system = emmeans(mod, pairwise ~ system, adjust = "none", type = "response"),
  system_entry = emmeans(mod, list(pairwise ~ system | entry), adjust = "none", type = "response")
)

# CLDs for Tukey
cld_results_tukey <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "tukey", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "tukey", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "tukey", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# CLDs for Fisher LSD
cld_results_lsd <- list(
  entry = cld(emmeans(mod, ~entry), adjust = "none", type = "response", 
              Letters = letters, sort = TRUE, reversed = TRUE),
  system = cld(emmeans(mod, ~system), adjust = "none", type = "response", 
               Letters = letters, sort = TRUE, reversed = TRUE),
  system_entry = cld(emmeans(mod, ~system | entry), adjust = "none", type = "response", 
                     Letters = letters, sort = TRUE, reversed = TRUE)
)

# Example: Accessing outputs
# Tukey
tukey_results$entry$emmeans
tukey_results$system$emmeans
tukey_results$system_entry$emmeans
tukey_results$entry$contrasts
tukey_results$system$contrasts
tukey_results$system_entry$contrasts
cld_results_tukey$entry
cld_results_tukey$system
cld_results_tukey$system_entry

# LSD
lsd_results$entry$emmeans
lsd_results$system$emmeans
lsd_results$system_entry$emmeans
lsd_results$entry$contrasts
lsd_results$system$contrasts
lsd_results$system_entry$contrasts
cld_results_lsd$entry
cld_results_lsd$system
cld_results_lsd$system_entry

```



```{r}
# Then move on to post-hoc using emmeans if indicated by the ANOVA. 
phoretic_hypopi.emm <- emmeans(models_phoretic_hypopi$binom1, ~treatments|entry, type="response"); pwpm(phoretic_hypopi.emm , adjust="none")

# Generate CLD output
cld_phoretic_hypopi <- cld(phoretic_hypopi.emm, Letters = letters, adjust = "none", sort = TRUE, reversed = TRUE)

# Print the results
cld_phoretic_hypopi


```

```{r message=FALSE}
ocs_invertebrates_clean |> 
  left_join(cld_phoretic_hypopi) |> 
  ggplot(aes(x = factor(treatments, levels = c("HF", "LF", "EWM", "RT")), 
             y = response, fill = treatments)) +
  facet_wrap(~entry, labeller = labeller(
    entry = c("A" = "Entry Point A", "B" = "Entry Point B")
  )) +
  geom_bar(stat = "identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin = response - SE, ymax = response + SE), 
                width = 0.2, position = position_dodge(0.9)) +
  geom_text(aes(label = trimws(.group), y = response + SE + 1.5), 
            size = 7) +
  labs(
    x = "",
     y = expression("Density" ~ (individuals ~ kg^{-1} ~ "dry soil")),
    subtitle = expression(italic("P < 0.05"))
  ) +
  scale_x_discrete(labels = c("High\nfertility", "Low\nfertility", 
                              "Enhanced\nweed\nmanagement", "Reduced\ntillage")) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.3))) +
  scale_fill_WB_d(name = "BlueberriesForSal", direction = 1) +
  theme_bw() +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 12),
    axis.title = element_text(size = 24),
    axis.text = element_text(size = 16),
    plot.subtitle = element_text(size = 24, face = "italic")
  )
ggsave("phoretic_hypopi_kg.png", width = 10, height = 6, dpi = 300)
```





```{r}
# Function to fit models and run diagnostics for a given response variable
test_glmm_models <- function(response_var, data) {
  
  # Define model formulas
  formula <- as.formula(paste(response_var, "~ treatments * entry + block + (1 | block:treatments)"))
  
  # Fit models with different distributions
  models <- list(
    binom1 = glmmTMB(formula, family = nbinom1(link = "log"), data = data),
    binom2 = glmmTMB(formula, family = nbinom2(link = "log"), data = data),
    poiss = glmmTMB(formula, family = poisson(link = "log"), data = data),
    tweedie = glmmTMB(formula, family = tweedie(link = "log"), data = data),
    zi = glmmTMB(formula, family = nbinom1(link = "log"), ziformula = ~ 1, data = data)
  )

  # Overdispersion check (using nbinom1)
  resid_pearson <- residuals(models$binom1, type = "pearson")
  dispersion_ratio <- sum(resid_pearson^2) / df.residual(models$binom1)
  cat("\n--- Overdispersion Check for", response_var, "---\n")
  cat("Dispersion Ratio:", round(dispersion_ratio, 2), "\n")
  
  # Zero inflation test
  sim_residuals <- simulateResiduals(models$binom1)
  zi_test <- testZeroInflation(sim_residuals)
  cat("Zero Inflation Test p-value:", zi_test$p.value, "\n")
  
  # Compare models using AIC
  aic_results <- AIC(models$binom1, models$binom2, models$poiss, models$tweedie, models$zi)
  print(aic_results)

  # Plot residual diagnostics
  plot(sim_residuals)
  
  # Check model fit visually
  check_model(models$binom1)  # Works with `performance` package
  
  return(models)  # Return models in case you want to use them later
}

# Run the function for total_oribatida
models_total_oribatida <- test_glmm_models("total_oribatida", ocs_invertebrates_clean)


```
#T-tests
##Total_organisms
```{r}


# Load the data

ocs_invertebrates_raw <- read_excel("~/Github/OCS_microarthropods/raw-data/ocs_invertebrates_kg.xlsx")
ocs_invertebrates_raw$block <- as.factor(ocs_invertebrates_raw$block)
ocs_invertebrates_raw$entry <- as.factor(ocs_invertebrates_raw$entry)
ocs_invertebrates_raw$system <- as.factor(ocs_invertebrates_raw$system)

# Step 1: Create subsets
alley_data <- ocs_invertebrates_raw %>% filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw %>% filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw %>% filter(!system %in% c("Alley", "Corn"))

# Subset
alley_data <- ocs_invertebrates_raw |> filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw |> filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw |> filter(!system %in% c("Alley", "Corn"))

## ---- ALLEYWAY COMPARISONS ----

# a. Alley vs each cropping system
alley_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(total_organisms, na.rm = TRUE),
    alley_mean = mean(alley_data$total_organisms, na.rm = TRUE),
    p_value = t.test(alley_data$total_organisms, total_organisms)$p.value,
    .groups = "drop"
  )

# b. Alley vs each entry point
alley_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(total_organisms, na.rm = TRUE),
    alley_mean = mean(alley_data$total_organisms, na.rm = TRUE),
    p_value = t.test(alley_data$total_organisms, total_organisms)$p.value,
    .groups = "drop"
  )

# c. Alley vs system x entry
alley_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(total_organisms, na.rm = TRUE),
    alley_mean = mean(alley_data$total_organisms, na.rm = TRUE),
    p_value = t.test(alley_data$total_organisms, total_organisms)$p.value,
    .groups = "drop"
  )

## ---- CORN FIELD COMPARISONS ----

# a. Corn vs each cropping system
corn_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(total_organisms, na.rm = TRUE),
    corn_mean = mean(corn_data$total_organisms, na.rm = TRUE),
    p_value = t.test(corn_data$total_organisms, total_organisms)$p.value,
    .groups = "drop"
  )

# b. Corn vs each entry point
corn_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(total_organisms, na.rm = TRUE),
    corn_mean = mean(corn_data$total_organisms, na.rm = TRUE),
    p_value = t.test(corn_data$total_organisms, total_organisms)$p.value,
    .groups = "drop"
  )

# c. Corn vs system x entry
corn_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(total_organisms, na.rm = TRUE),
    corn_mean = mean(corn_data$total_organisms, na.rm = TRUE),
    p_value = t.test(corn_data$total_organisms, total_organisms)$p.value,
    .groups = "drop"
  )

# View tables
alley_vs_system
alley_vs_entry
alley_vs_sys_entry

corn_vs_system
corn_vs_entry
corn_vs_sys_entry

tibble(
  alley_mean = mean(alley_data$total_organisms, na.rm = TRUE),
  corn_mean  = mean(corn_data$total_organisms, na.rm = TRUE),
  p_value    = t.test(alley_data$total_organisms, corn_data$total_organisms)$p.value
)

```

##Total_collembola
```{r}


# Load the data

ocs_invertebrates_raw <- read_excel("~/Github/OCS_microarthropods/raw-data/ocs_invertebrates_kg.xlsx")
ocs_invertebrates_raw$block <- as.factor(ocs_invertebrates_raw$block)
ocs_invertebrates_raw$entry <- as.factor(ocs_invertebrates_raw$entry)
ocs_invertebrates_raw$system <- as.factor(ocs_invertebrates_raw$system)

# Step 1: Create subsets
alley_data <- ocs_invertebrates_raw %>% filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw %>% filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw %>% filter(!system %in% c("Alley", "Corn"))

# Subset
alley_data <- ocs_invertebrates_raw |> filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw |> filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw |> filter(!system %in% c("Alley", "Corn"))

## ---- ALLEYWAY COMPARISONS ----

# a. Alley vs each cropping system
alley_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(total_collembola, na.rm = TRUE),
    alley_mean = mean(alley_data$total_collembola, na.rm = TRUE),
    p_value = t.test(alley_data$total_collembola, total_collembola)$p.value,
    .groups = "drop"
  )

# b. Alley vs each entry point
alley_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(total_collembola, na.rm = TRUE),
    alley_mean = mean(alley_data$total_collembola, na.rm = TRUE),
    p_value = t.test(alley_data$total_collembola, total_collembola)$p.value,
    .groups = "drop"
  )

# c. Alley vs system x entry
alley_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(total_collembola, na.rm = TRUE),
    alley_mean = mean(alley_data$total_collembola, na.rm = TRUE),
    p_value = t.test(alley_data$total_collembola, total_collembola)$p.value,
    .groups = "drop"
  )

## ---- CORN FIELD COMPARISONS ----

# a. Corn vs each cropping system
corn_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(total_collembola, na.rm = TRUE),
    corn_mean = mean(corn_data$total_collembola, na.rm = TRUE),
    p_value = t.test(corn_data$total_collembola, total_collembola)$p.value,
    .groups = "drop"
  )

# b. Corn vs each entry point
corn_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(total_collembola, na.rm = TRUE),
    corn_mean = mean(corn_data$total_collembola, na.rm = TRUE),
    p_value = t.test(corn_data$total_collembola, total_collembola)$p.value,
    .groups = "drop"
  )

# c. Corn vs system x entry
corn_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(total_collembola, na.rm = TRUE),
    corn_mean = mean(corn_data$total_collembola, na.rm = TRUE),
    p_value = t.test(corn_data$total_collembola, total_collembola)$p.value,
    .groups = "drop"
  )

# View tables
alley_vs_system
alley_vs_entry
alley_vs_sys_entry

corn_vs_system
corn_vs_entry
corn_vs_sys_entry

tibble(
  alley_mean = mean(alley_data$total_organisms, na.rm = TRUE),
  corn_mean  = mean(corn_data$total_organisms, na.rm = TRUE),
  p_value    = t.test(alley_data$total_organisms, corn_data$total_organisms)$p.value
)

```

##Onychiuridae
```{r}


# Load the data

ocs_invertebrates_raw <- read_excel("~/Github/OCS_microarthropods/raw-data/ocs_invertebrates_kg.xlsx")
ocs_invertebrates_raw$block <- as.factor(ocs_invertebrates_raw$block)
ocs_invertebrates_raw$entry <- as.factor(ocs_invertebrates_raw$entry)
ocs_invertebrates_raw$system <- as.factor(ocs_invertebrates_raw$system)

# Step 1: Create subsets
alley_data <- ocs_invertebrates_raw %>% filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw %>% filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw %>% filter(!system %in% c("Alley", "Corn"))

# Subset
alley_data <- ocs_invertebrates_raw |> filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw |> filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw |> filter(!system %in% c("Alley", "Corn"))

## ---- ALLEYWAY COMPARISONS ----

# a. Alley vs each cropping system
alley_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(onychiuridae, na.rm = TRUE),
    alley_mean = mean(alley_data$onychiuridae, na.rm = TRUE),
    p_value = t.test(alley_data$onychiuridae, onychiuridae)$p.value,
    .groups = "drop"
  )

# b. Alley vs each entry point
alley_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(onychiuridae, na.rm = TRUE),
    alley_mean = mean(alley_data$onychiuridae, na.rm = TRUE),
    p_value = t.test(alley_data$onychiuridae, onychiuridae)$p.value,
    .groups = "drop"
  )

# c. Alley vs system x entry
alley_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(onychiuridae, na.rm = TRUE),
    alley_mean = mean(alley_data$onychiuridae, na.rm = TRUE),
    p_value = t.test(alley_data$onychiuridae, onychiuridae)$p.value,
    .groups = "drop"
  )

## ---- CORN FIELD COMPARISONS ----

# a. Corn vs each cropping system
corn_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(onychiuridae, na.rm = TRUE),
    corn_mean = mean(corn_data$onychiuridae, na.rm = TRUE),
    p_value = t.test(corn_data$onychiuridae, onychiuridae)$p.value,
    .groups = "drop"
  )

# b. Corn vs each entry point
corn_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(onychiuridae, na.rm = TRUE),
    corn_mean = mean(corn_data$onychiuridae, na.rm = TRUE),
    p_value = t.test(corn_data$onychiuridae, onychiuridae)$p.value,
    .groups = "drop"
  )

# c. Corn vs system x entry
corn_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(onychiuridae, na.rm = TRUE),
    corn_mean = mean(corn_data$onychiuridae, na.rm = TRUE),
    p_value = t.test(corn_data$onychiuridae, onychiuridae)$p.value,
    .groups = "drop"
  )

# View tables
alley_vs_system
alley_vs_entry
alley_vs_sys_entry

corn_vs_system
corn_vs_entry
corn_vs_sys_entry

tibble(
  alley_mean = mean(alley_data$onychiuridae, na.rm = TRUE),
  corn_mean  = mean(corn_data$onychiuridae, na.rm = TRUE),
  p_value    = t.test(alley_data$onychiuridae, corn_data$onychiuridae)$p.value
)

```

##Isotomidae
```{r}


# Load the data

ocs_invertebrates_raw <- read_excel("~/Github/OCS_microarthropods/raw-data/ocs_invertebrates_kg.xlsx")
ocs_invertebrates_raw$block <- as.factor(ocs_invertebrates_raw$block)
ocs_invertebrates_raw$entry <- as.factor(ocs_invertebrates_raw$entry)
ocs_invertebrates_raw$system <- as.factor(ocs_invertebrates_raw$system)

# Step 1: Create subsets
alley_data <- ocs_invertebrates_raw %>% filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw %>% filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw %>% filter(!system %in% c("Alley", "Corn"))

# Subset
alley_data <- ocs_invertebrates_raw |> filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw |> filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw |> filter(!system %in% c("Alley", "Corn"))

## ---- ALLEYWAY COMPARISONS ----

# a. Alley vs each cropping system
alley_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(isotomidae, na.rm = TRUE),
    alley_mean = mean(alley_data$isotomidae, na.rm = TRUE),
    p_value = t.test(alley_data$isotomidae, cur_data()$isotomidae)$p.value,
    .groups = "drop"
  )

# b. Alley vs each entry point
alley_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(isotomidae, na.rm = TRUE),
    alley_mean = mean(alley_data$isotomidae, na.rm = TRUE),
    p_value = t.test(alley_data$isotomidae, cur_data()$isotomidae)$p.value,
    .groups = "drop"
  )

# c. Alley vs system x entry
alley_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(isotomidae, na.rm = TRUE),
    alley_mean = mean(alley_data$isotomidae, na.rm = TRUE),
    p_value = t.test(alley_data$isotomidae, cur_data()$isotomidae)$p.value,
    .groups = "drop"
  )

## ---- CORN FIELD COMPARISONS ----

# a. Corn vs each cropping system
corn_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(isotomidae, na.rm = TRUE),
    corn_mean = mean(corn_data$isotomidae, na.rm = TRUE),
    p_value = t.test(corn_data$isotomidae, cur_data()$isotomidae)$p.value,
    .groups = "drop"
  )

# b. Corn vs each entry point
corn_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(isotomidae, na.rm = TRUE),
    corn_mean = mean(corn_data$isotomidae, na.rm = TRUE),
    p_value = t.test(corn_data$isotomidae, cur_data()$isotomidae)$p.value,
    .groups = "drop"
  )

# c. Corn vs system x entry
corn_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(isotomidae, na.rm = TRUE),
    corn_mean = mean(corn_data$isotomidae, na.rm = TRUE),
    p_value = t.test(corn_data$isotomidae, cur_data()$isotomidae)$p.value,
    .groups = "drop"
  )

# View tables
alley_vs_system
alley_vs_entry
alley_vs_sys_entry

corn_vs_system
corn_vs_entry
corn_vs_sys_entry

tibble(
  alley_mean = mean(alley_data$isotomidae, na.rm = TRUE),
  corn_mean  = mean(corn_data$isotomidae, na.rm = TRUE),
  p_value    = t.test(alley_data$isotomidae, corn_data$isotomidae)$p.value
)

```
##Total mites
```{r}


# Load the data

ocs_invertebrates_raw <- read_excel("~/Github/OCS_microarthropods/raw-data/ocs_invertebrates_kg.xlsx")
ocs_invertebrates_raw$block <- as.factor(ocs_invertebrates_raw$block)
ocs_invertebrates_raw$entry <- as.factor(ocs_invertebrates_raw$entry)
ocs_invertebrates_raw$system <- as.factor(ocs_invertebrates_raw$system)

# Step 1: Create subsets
alley_data <- ocs_invertebrates_raw %>% filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw %>% filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw %>% filter(!system %in% c("Alley", "Corn"))

# Subset
alley_data <- ocs_invertebrates_raw |> filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw |> filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw |> filter(!system %in% c("Alley", "Corn"))

## ---- ALLEYWAY COMPARISONS ----

# a. Alley vs each cropping system
alley_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(total_mites, na.rm = TRUE),
    alley_mean = mean(alley_data$total_mites, na.rm = TRUE),
    p_value = t.test(alley_data$total_mites, cur_data()$total_mites)$p.value,
    .groups = "drop"
  )

# b. Alley vs each entry point
alley_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(total_mites, na.rm = TRUE),
    alley_mean = mean(alley_data$total_mites, na.rm = TRUE),
    p_value = t.test(alley_data$total_mites, cur_data()$total_mites)$p.value,
    .groups = "drop"
  )

# c. Alley vs system x entry
alley_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(total_mites, na.rm = TRUE),
    alley_mean = mean(alley_data$total_mites, na.rm = TRUE),
    p_value = t.test(alley_data$total_mites, cur_data()$total_mites)$p.value,
    .groups = "drop"
  )

## ---- CORN FIELD COMPARISONS ----

# a. Corn vs each cropping system
corn_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(total_mites, na.rm = TRUE),
    corn_mean = mean(corn_data$total_mites, na.rm = TRUE),
    p_value = t.test(corn_data$total_mites, cur_data()$total_mites)$p.value,
    .groups = "drop"
  )

# b. Corn vs each entry point
corn_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(total_mites, na.rm = TRUE),
    corn_mean = mean(corn_data$total_mites, na.rm = TRUE),
    p_value = t.test(corn_data$total_mites, cur_data()$total_mites)$p.value,
    .groups = "drop"
  )

# c. Corn vs system x entry
corn_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(total_mites, na.rm = TRUE),
    corn_mean = mean(corn_data$total_mites, na.rm = TRUE),
    p_value = t.test(corn_data$total_mites, cur_data()$total_mites)$p.value,
    .groups = "drop"
  )

# View tables
alley_vs_system
alley_vs_entry
alley_vs_sys_entry

corn_vs_system
corn_vs_entry
corn_vs_sys_entry

tibble(
  alley_mean = mean(alley_data$total_mites, na.rm = TRUE),
  corn_mean  = mean(corn_data$total_mites, na.rm = TRUE),
  p_value    = t.test(alley_data$total_mites, corn_data$total_mites)$p.value
)

```

##Astigmata
```{r}


# Load the data

ocs_invertebrates_raw <- read_excel("~/Github/OCS_microarthropods/raw-data/ocs_invertebrates_kg.xlsx")
ocs_invertebrates_raw$block <- as.factor(ocs_invertebrates_raw$block)
ocs_invertebrates_raw$entry <- as.factor(ocs_invertebrates_raw$entry)
ocs_invertebrates_raw$system <- as.factor(ocs_invertebrates_raw$system)

# Step 1: Create subsets
alley_data <- ocs_invertebrates_raw %>% filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw %>% filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw %>% filter(!system %in% c("Alley", "Corn"))

# Subset
alley_data <- ocs_invertebrates_raw |> filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw |> filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw |> filter(!system %in% c("Alley", "Corn"))

## ---- ALLEYWAY COMPARISONS ----

# a. Alley vs each cropping system
alley_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(astigmata, na.rm = TRUE),
    alley_mean = mean(alley_data$astigmata, na.rm = TRUE),
    p_value = t.test(alley_data$astigmata, cur_data()$astigmata)$p.value,
    .groups = "drop"
  )

# b. Alley vs each entry point
alley_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(astigmata, na.rm = TRUE),
    alley_mean = mean(alley_data$astigmata, na.rm = TRUE),
    p_value = t.test(alley_data$astigmata, cur_data()$astigmata)$p.value,
    .groups = "drop"
  )

# c. Alley vs system x entry
alley_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(astigmata, na.rm = TRUE),
    alley_mean = mean(alley_data$astigmata, na.rm = TRUE),
    p_value = t.test(alley_data$astigmata, cur_data()$astigmata)$p.value,
    .groups = "drop"
  )

## ---- CORN FIELD COMPARISONS ----

# a. Corn vs each cropping system
corn_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(astigmata, na.rm = TRUE),
    corn_mean = mean(corn_data$astigmata, na.rm = TRUE),
    p_value = t.test(corn_data$astigmata, cur_data()$astigmata)$p.value,
    .groups = "drop"
  )

# b. Corn vs each entry point
corn_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(astigmata, na.rm = TRUE),
    corn_mean = mean(corn_data$astigmata, na.rm = TRUE),
    p_value = t.test(corn_data$astigmata, cur_data()$astigmata)$p.value,
    .groups = "drop"
  )

# c. Corn vs system x entry
corn_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(astigmata, na.rm = TRUE),
    corn_mean = mean(corn_data$astigmata, na.rm = TRUE),
    p_value = t.test(corn_data$astigmata, cur_data()$astigmata)$p.value,
    .groups = "drop"
  )

# View tables
alley_vs_system
alley_vs_entry
alley_vs_sys_entry

corn_vs_system
corn_vs_entry
corn_vs_sys_entry

tibble(
  alley_mean = mean(alley_data$astigmata, na.rm = TRUE),
  corn_mean  = mean(corn_data$astigmata, na.rm = TRUE),
  p_value    = t.test(alley_data$astigmata, corn_data$astigmata)$p.value
)

```

##Mesostigmata
```{r}


# Load the data

ocs_invertebrates_raw <- read_excel("~/Github/OCS_microarthropods/raw-data/ocs_invertebrates_kg.xlsx")
ocs_invertebrates_raw$block <- as.factor(ocs_invertebrates_raw$block)
ocs_invertebrates_raw$entry <- as.factor(ocs_invertebrates_raw$entry)
ocs_invertebrates_raw$system <- as.factor(ocs_invertebrates_raw$system)

# Step 1: Create subsets
alley_data <- ocs_invertebrates_raw %>% filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw %>% filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw %>% filter(!system %in% c("Alley", "Corn"))

# Subset
alley_data <- ocs_invertebrates_raw |> filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw |> filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw |> filter(!system %in% c("Alley", "Corn"))

## ---- ALLEYWAY COMPARISONS ----

# a. Alley vs each cropping system
alley_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(mesostigmata, na.rm = TRUE),
    alley_mean = mean(alley_data$mesostigmata, na.rm = TRUE),
    p_value = t.test(alley_data$mesostigmata, cur_data()$mesostigmata)$p.value,
    .groups = "drop"
  )

# b. Alley vs each entry point
alley_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(mesostigmata, na.rm = TRUE),
    alley_mean = mean(alley_data$mesostigmata, na.rm = TRUE),
    p_value = t.test(alley_data$mesostigmata, cur_data()$mesostigmata)$p.value,
    .groups = "drop"
  )

# c. Alley vs system x entry
alley_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(mesostigmata, na.rm = TRUE),
    alley_mean = mean(alley_data$mesostigmata, na.rm = TRUE),
    p_value = t.test(alley_data$mesostigmata, cur_data()$mesostigmata)$p.value,
    .groups = "drop"
  )

## ---- CORN FIELD COMPARISONS ----

# a. Corn vs each cropping system
corn_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(mesostigmata, na.rm = TRUE),
    corn_mean = mean(corn_data$mesostigmata, na.rm = TRUE),
    p_value = t.test(corn_data$mesostigmata, cur_data()$mesostigmata)$p.value,
    .groups = "drop"
  )

# b. Corn vs each entry point
corn_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(mesostigmata, na.rm = TRUE),
    corn_mean = mean(corn_data$mesostigmata, na.rm = TRUE),
    p_value = t.test(corn_data$mesostigmata, cur_data()$mesostigmata)$p.value,
    .groups = "drop"
  )

# c. Corn vs system x entry
corn_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(mesostigmata, na.rm = TRUE),
    corn_mean = mean(corn_data$mesostigmata, na.rm = TRUE),
    p_value = t.test(corn_data$mesostigmata, cur_data()$mesostigmata)$p.value,
    .groups = "drop"
  )

# View tables
alley_vs_system
alley_vs_entry
alley_vs_sys_entry

corn_vs_system
corn_vs_entry
corn_vs_sys_entry

tibble(
  alley_mean = mean(alley_data$mesostigmata, na.rm = TRUE),
  corn_mean  = mean(corn_data$mesostigmata, na.rm = TRUE),
  p_value    = t.test(alley_data$mesostigmata, corn_data$mesostigmata)$p.value
)

```

##Phoretic hypopi
```{r}


# Load the data

ocs_invertebrates_raw <- read_excel("~/Github/OCS_microarthropods/raw-data/ocs_invertebrates_kg.xlsx")
ocs_invertebrates_raw$block <- as.factor(ocs_invertebrates_raw$block)
ocs_invertebrates_raw$entry <- as.factor(ocs_invertebrates_raw$entry)
ocs_invertebrates_raw$system <- as.factor(ocs_invertebrates_raw$system)

# Step 1: Create subsets
alley_data <- ocs_invertebrates_raw %>% filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw %>% filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw %>% filter(!system %in% c("Alley", "Corn"))

# Subset
alley_data <- ocs_invertebrates_raw |> filter(system == "Alley")
corn_data  <- ocs_invertebrates_raw |> filter(system == "Corn")
treatment_data <- ocs_invertebrates_raw |> filter(!system %in% c("Alley", "Corn"))

## ---- ALLEYWAY COMPARISONS ----

# a. Alley vs each cropping system
alley_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(phoretic_hypopi, na.rm = TRUE),
    alley_mean = mean(alley_data$phoretic_hypopi, na.rm = TRUE),
    p_value = t.test(alley_data$phoretic_hypopi, cur_data()$phoretic_hypopi)$p.value,
    .groups = "drop"
  )

# b. Alley vs each entry point
alley_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(phoretic_hypopi, na.rm = TRUE),
    alley_mean = mean(alley_data$phoretic_hypopi, na.rm = TRUE),
    p_value = t.test(alley_data$phoretic_hypopi, cur_data()$phoretic_hypopi)$p.value,
    .groups = "drop"
  )

# c. Alley vs system x entry
alley_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(phoretic_hypopi, na.rm = TRUE),
    alley_mean = mean(alley_data$phoretic_hypopi, na.rm = TRUE),
    p_value = t.test(alley_data$phoretic_hypopi, cur_data()$phoretic_hypopi)$p.value,
    .groups = "drop"
  )

## ---- CORN FIELD COMPARISONS ----

# a. Corn vs each cropping system
corn_vs_system <- ocs_invertebrates_raw |>
  group_by(system) |>
  summarise(
    treatment_mean = mean(phoretic_hypopi, na.rm = TRUE),
    corn_mean = mean(corn_data$phoretic_hypopi, na.rm = TRUE),
    p_value = t.test(corn_data$phoretic_hypopi, cur_data()$phoretic_hypopi)$p.value,
    .groups = "drop"
  )

# b. Corn vs each entry point
corn_vs_entry <- ocs_invertebrates_raw |>
  group_by(entry) |>
  summarise(
    treatment_mean = mean(phoretic_hypopi, na.rm = TRUE),
    corn_mean = mean(corn_data$phoretic_hypopi, na.rm = TRUE),
    p_value = t.test(corn_data$phoretic_hypopi, cur_data()$phoretic_hypopi)$p.value,
    .groups = "drop"
  )

# c. Corn vs system x entry
corn_vs_sys_entry <- ocs_invertebrates_raw |>
  group_by(system, entry) |>
  summarise(
    treatment_mean = mean(phoretic_hypopi, na.rm = TRUE),
    corn_mean = mean(corn_data$phoretic_hypopi, na.rm = TRUE),
    p_value = t.test(corn_data$phoretic_hypopi, cur_data()$phoretic_hypopi)$p.value,
    .groups = "drop"
  )

# View tables
alley_vs_system
alley_vs_entry
alley_vs_sys_entry

corn_vs_system
corn_vs_entry
corn_vs_sys_entry

tibble(
  alley_mean = mean(alley_data$phoretic_hypopi, na.rm = TRUE),
  corn_mean  = mean(corn_data$phoretic_hypopi, na.rm = TRUE),
  p_value    = t.test(alley_data$phoretic_hypopi, corn_data$phoretic_hypopi)$p.value
)

```
